document.addEventListener('DOMContentLoaded', () => {
  // ======================================
  // DATOS DE PELÍCULAS
  // ======================================
  const peliculas = [
    {titulo:"Contracara", descripcion:"Dos enemigos intercambian rostros.", genero:["Acción","Suspenso"], imagen:"https://m.media-amazon.com/images/I/81yA4lXObKL._AC_UF220,320_QL80_.jpg", video:"https://drive.google.com/file/d/1FsEqOKWlq4zMSeYOF-7tp_UB4jTKujqn/preview", año:2025},
    {titulo:"Interstellar", descripcion:"Un viaje épico a través del espacio.", genero:["Ciencia ficción","Drama"], imagen:"https://m.media-amazon.com/images/I/91+U4p2ZBtL._AC_UF220,320_QL80_.jpg", video:"https://drive.google.com/file/d/1cVVPgzsRjlombZxDsP2YWa9F9cHs0xa7/preview", año:2023},
    {titulo:"Karate Kid", descripcion:"Un joven aprende kung fu.", genero:["Acción","Drama"], imagen:"https://m.media-amazon.com/images/I/81niGl1vTqL._AC_UF220,320_QL80_.jpg", video:"https://drive.google.com/file/d/1vytWPJ8SuHa5cLsXWXQFHsCA26jspc5/preview", año:2024},
    {titulo:"La leyenda de los Chaneques", descripcion:"Aventuras de los chaneques.", genero:["Animación","Familia","Aventura"], imagen:"https://m.media-amazon.com/images/I/71i4JK5pR-L._AC_UF220,320_QL80_.jpg", video:"https://drive.google.com/file/d/1j2-DvVDho1-u6DoJhZpr3fG6mpyAMGL5/preview", año:2025},
    {titulo:"Tiempo Congelado", descripcion:"Un reloj que detiene el tiempo.", genero:["Acción","Ciencia ficción","Comedia"], imagen:"https://m.media-amazon.com/images/I/81r+LNv5bQL._AC_UF220,320_QL80_.jpg", video:"https://drive.google.com/file/d/1mi8Ltlqx01KVDLKIIQXL0l05A_i5endV/preview", año:2022},
    {titulo:"Venom 3", descripcion:"Eddie y Venom enfrentan nuevos desafíos.", genero:["Acción","Superhéroes"], imagen:"https://m.media-amazon.com/images/I/81kq5pCVSML._AC_UF220,320_QL80_.jpg", video:"https://drive.google.com/file/d/1-I98WaJ_C622i2YMeBFjcEn43808KgmR/preview", año:2023}
  ];

  // ======================================
  // DATOS DE SERIES
  // ======================================
  const seriesData = [
    {
      titulo:"What If...?", descripcion:"Explora universos alternativos del MCU.", imagen:"https://m.media-amazon.com/images/I/81xqVqZy+GL._AC_SY679_.jpg",
      temporadas:[
        {titulo:"Temporada 1", capitulos:["Capítulo 1: ¿Qué pasaría si...?","Capítulo 2: La escena X","Capítulo 3: Otra historia"]},
        {titulo:"Temporada 2", capitulos:["Capítulo 1: Nuevos eventos","Capítulo 2: Más aventuras"]}
      ]
    },
    {
      titulo:"Stranger Things", descripcion:"Aventuras paranormales en Hawkins.", imagen:"https://m.media-amazon.com/images/I/81V2YqR1hgL._AC_SY679_.jpg",
      temporadas:[
        {titulo:"Temporada 1", capitulos:["Capítulo 1: La desaparición","Capítulo 2: El misterio"]},
        {titulo:"Temporada 2", capitulos:["Capítulo 1: La conspiración","Capítulo 2: Nuevos secretos"]}
      ]
    }
  ];

  // ======================================
  // DETECTAR PÁGINA ACTUAL
  // ======================================
  const path = window.location.pathname.split("/").pop();

  // ======================================
  // FUNCIONES COMUNES
  // ======================================
  function initModal(){
    const modal = document.getElementById('modal');
    const modalContent = document.getElementById('modalContent') || document.getElementById('modalBody');
    const closeModal = document.getElementById('closeModal');
    if(!modal || !modalContent || !closeModal) return;
    closeModal.addEventListener('click', ()=>{ modal.style.display='none'; if(modalContent.tagName==="DIV") modalContent.innerHTML=''; else document.getElementById('moviePlayer').src=''; });
    window.addEventListener('click', e=>{ if(e.target===modal){ modal.style.display='none'; if(modalContent.tagName==="DIV") modalContent.innerHTML=''; else document.getElementById('moviePlayer').src=''; } });
    window.addEventListener('keydown', e=>{ if(e.key==='Escape'){ modal.style.display='none'; if(modalContent.tagName==="DIV") modalContent.innerHTML=''; else document.getElementById('moviePlayer').src=''; } });
  }

  // ======================================
  // INDEX / MÁS RECIENTES
  // ======================================
  if(path === "index.html" || path === "mas-recientes.html"){
    const moviesContainer = document.getElementById('movies');
    const searchInput = document.getElementById('search');
    const noResults = document.getElementById('no-results');
    const modal = document.getElementById('modal');
    const moviePlayer = document.getElementById('moviePlayer');

    const listaPeliculas = path === "mas-recientes.html" ? peliculas.filter(p=>p.año >= 2023) : peliculas;

    const fuse = new Fuse(listaPeliculas, {keys:['titulo','descripcion','genero'], threshold:0.3});

    function mostrarPeliculas(lista){
      moviesContainer.innerHTML='';
      if(lista.length===0){ noResults.style.display='block'; return; }
      noResults.style.display='none';
      lista.forEach(p=>{
        const card = document.createElement('div');
        card.classList.add('movie-card');
        const boton = p.video ? `<a href="#" class="playMovie" data-video="${p.video}">🎬 Reproducir</a>` : `<button>Próximamente</button>`;
        card.innerHTML = `
          <img src="${p.imagen}" loading="lazy" alt="${p.titulo}" onerror="this.src='https://via.placeholder.com/220x320?text=Sin+imagen';">
          <h3>${p.titulo}</h3>
          <p>${p.genero.join(', ')}</p>
          <p>${p.descripcion}</p>
          ${boton}`;
        moviesContainer.appendChild(card);
      });

      document.querySelectorAll('.playMovie').forEach(btn=>{
        btn.addEventListener('click', e=>{
          e.preventDefault();
          moviePlayer.src = btn.dataset.video;
          modal.style.display='flex';
        });
      });
    }

    mostrarPeliculas(listaPeliculas);
    initModal();

    let debounceTimer;
    searchInput.addEventListener('input', ()=>{
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(()=>{
        const results = searchInput.value ? fuse.search(searchInput.value).map(r=>r.item) : listaPeliculas;
        mostrarPeliculas(results);
      },200);
    });
  }

  // ======================================
  // SERIES
  // ======================================
  if(path === "series.html"){
    const seriesContainer = document.getElementById('series');
    const searchInput = document.getElementById('search');
    const noResults = document.getElementById('no-results');

    function mostrarSeries(lista){
      seriesContainer.innerHTML='';
      if(lista.length===0){ noResults.style.display='block'; return; }
      noResults.style.display='none';
      lista.forEach(s=>{
        const card = document.createElement('div');
        card.classList.add('series-card');
        card.innerHTML = `<img src="${s.imagen}" loading="lazy" alt="${s.titulo}" onerror="this.src='https://via.placeholder.com/220x320?text=Sin+imagen';">
                          <h3>${s.titulo}</h3>`;
        card.addEventListener('click', ()=>abrirModalSerie(s));
        seriesContainer.appendChild(card);
      });
    }

    function abrirModalSerie(serie){
      const modalBody = document.getElementById('modalBody');
      modalBody.innerHTML = `
        <img src="${serie.imagen}" alt="${serie.titulo}">
        <h2>${serie.titulo}</h2>
        <p>${serie.descripcion}</p>
        ${serie.temporadas.map((t,i)=>`
          <div class="temporada">
            <h3 data-index="${i}">${t.titulo}</h3>
            <ul class="capitulos">
              ${t.capitulos.map(c=>`<li>${c}</li>`).join('')}
            </ul>
          </div>`).join('')}
      `;
      document.getElementById('modal').style.display='flex';
      // Colapsar capítulos inicialmente
      document.querySelectorAll('.temporada .capitulos').forEach(u=>u.style.display='none');
      document.querySelectorAll('.temporada h3').forEach(h=>{
        h.style.cursor='pointer';
        h.addEventListener('click', ()=>{
          const ul = h.nextElementSibling;
          ul.style.display = ul.style.display==='none'?'block':'none';
        });
      });
    }

    const fuse = new Fuse(seriesData,{keys:['titulo','descripcion'], threshold:0.3});
    mostrarSeries(seriesData);
    initModal();

    let debounceTimer;
    searchInput.addEventListener('input', ()=>{
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(()=>{
        const results = searchInput.value ? fuse.search(searchInput.value).map(r=>r.item) : seriesData;
        mostrarSeries(results);
      },200);
    });
  }

});
